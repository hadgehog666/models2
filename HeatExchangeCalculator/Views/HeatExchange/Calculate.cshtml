@* Views/HeatExchange/Calculate.cshtml *@
@model HeatExchangeCalculator.Models.CalculationViewModel

@{
    ViewData["Title"] = "Расчет теплообмена";
    var inputData = Model?.InputData ?? new HeatExchangeCalculator.Models.HeatExchangeModel();
}

<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-thermometer-sun"></i> Расчет теплообмена в противоточном движении
    </h1>

    <div class="row">
        <!-- Левая колонка - Ввод данных -->
        <div class="col-lg-5">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-input-cursor-text"></i> Исходные данные
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" id="calculationForm">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label asp-for="InputData!.CalculationName" class="form-label">
                                <i class="bi bi-tag"></i> Название расчета
                            </label>
                            <input asp-for="InputData!.CalculationName" class="form-control"
                                   placeholder="Введите название расчета" />
                            <span asp-validation-for="InputData!.CalculationName" class="text-danger small"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.Height" class="form-label">
                                    <i class="bi bi-arrows-vertical"></i> Высота слоя, м
                                </label>
                                <input asp-for="InputData!.Height" class="form-control" />
                                <span asp-validation-for="InputData!.Height" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.ApparatusDiameter" class="form-label">
                                    <i class="bi bi-circle"></i> Диаметр аппарата, м
                                </label>
                                <input asp-for="InputData!.ApparatusDiameter" class="form-control" />
                                <span asp-validation-for="InputData!.ApparatusDiameter" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.InitialMaterialTemp" class="form-label">
                                    <i class="bi bi-thermometer-half"></i> Темп. материала, °C
                                </label>
                                <input asp-for="InputData!.InitialMaterialTemp" class="form-control" />
                                <span asp-validation-for="InputData!.InitialMaterialTemp" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.InitialGasTemp" class="form-label">
                                    <i class="bi bi-thermometer-high"></i> Темп. газа, °C
                                </label>
                                <input asp-for="InputData!.InitialGasTemp" class="form-control" />
                                <span asp-validation-for="InputData!.InitialGasTemp" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.GasVelocity" class="form-label">
                                    <i class="bi bi-speedometer"></i> Скорость газа, м/с
                                </label>
                                <input asp-for="InputData!.GasVelocity" class="form-control" />
                                <span asp-validation-for="InputData!.GasVelocity" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.GasHeatCapacity" class="form-label">
                                    <i class="bi bi-droplet"></i> Теплоемкость газа, кДж/(м³·К)
                                </label>
                                <input asp-for="InputData!.GasHeatCapacity" class="form-control" />
                                <span asp-validation-for="InputData!.GasHeatCapacity" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.MaterialConsumption" class="form-label">
                                    <i class="bi bi-box"></i> Расход материала, кг/с
                                </label>
                                <input asp-for="InputData!.MaterialConsumption" class="form-control" />
                                <span asp-validation-for="InputData!.MaterialConsumption" class="text-danger small"></span>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label asp-for="InputData!.MaterialHeatCapacity" class="form-label">
                                    <i class="bi bi-fire"></i> Теплоемкость материала, кДж/(кг·К)
                                </label>
                                <input asp-for="InputData!.MaterialHeatCapacity" class="form-control" />
                                <span asp-validation-for="InputData!.MaterialHeatCapacity" class="text-danger small"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="InputData!.HeatTransferCoefficient" class="form-label">
                                <i class="bi bi-arrow-left-right"></i> Коэффициент теплоотдачи, Вт/(м³·К)
                            </label>
                            <input asp-for="InputData!.HeatTransferCoefficient" class="form-control" />
                            <span asp-validation-for="InputData!.HeatTransferCoefficient" class="text-danger small"></span>
                        </div>

                        <div class="d-grid gap-2 d-md-flex">
                            <button type="submit" class="btn btn-primary flex-fill">
                                <i class="bi bi-calculator"></i> Рассчитать
                            </button>
                            <button type="submit" formaction="@Url.Action("SaveCalculation")"
                                    class="btn btn-success flex-fill">
                                <i class="bi bi-save"></i> Сохранить
                            </button>
                            <a href="@Url.Action("Index")" class="btn btn-secondary">
                                <i class="bi bi-arrow-clockwise"></i> Сбросить
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Быстрые настройки -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-lightning-charge"></i> Быстрые настройки</h6>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-outline-primary"
                                onclick="setValues(6, 15, 600, 0.73, 1.09, 1.68, 1.49, 2440, 2.2)">
                            Вариант 12
                        </button>
                        <button type="button" class="btn btn-outline-success"
                                onclick="setValues(3, 600, 0, 0.78, 1.31, 1.72, 1.49, 2460, 2)">
                            Контрольный
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая колонка - Результаты -->
        <div class="col-lg-7">
            @if (Model?.Results?.Count > 0)
            {
                <!-- Карточка с параметрами -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up"></i> Параметры расчета
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <small class="text-muted">m</small>
                                    <h4 class="mb-0 text-primary">@Model.M.ToString("F3")</h4>
                                    <small>Отношение теплоемкостей</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <small class="text-muted">Y₀</small>
                                    <h4 class="mb-0 text-success">@Model.Y0.ToString("F2")</h4>
                                    <small>Относительная высота</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <small class="text-muted">S</small>
                                    <h4 class="mb-0 text-info">@Model.CrossSection.ToString("F3")</h4>
                                    <small>Площадь сечения, м²</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-light rounded">
                                    <small class="text-muted">ΔT</small>
                                    <h4 class="mb-0 text-danger">
                                        @Model.Results.Last().TemperatureDifference.ToString("F1")
                                    </h4>
                                    <small>Конечная разность</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Таблица результатов -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-table"></i> Результаты расчета
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-light" onclick="exportToCSV()">
                                <i class="bi bi-download"></i> CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-striped table-hover mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th class="text-center">y, м</th>
                                        <th class="text-center">Y</th>
                                        <th class="text-center">ϑ</th>
                                        <th class="text-center">θ</th>
                                        <th class="text-center">t, °C</th>
                                        <th class="text-center">T, °C</th>
                                        <th class="text-center">ΔT, °C</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var result in Model.Results)
                                    {
                                        <tr>
                                            <td class="text-center">@result.HeightCoordinate.ToString("F1")</td>
                                            <td class="text-center">@result.Y.ToString("F2")</td>
                                            <td class="text-center">@result.Phi.ToString("F3")</td>
                                            <td class="text-center">@result.Theta.ToString("F3")</td>
                                            <td class="text-center @(result.MaterialTemperature > 500 ? "text-danger" : "text-primary")">
                                                @result.MaterialTemperature.ToString("F1")
                                            </td>
                                            <td class="text-center @(result.GasTemperature > 500 ? "text-danger" : "text-warning")">
                                                @result.GasTemperature.ToString("F1")
                                            </td>
                                            <td class="text-center @(result.TemperatureDifference > 100 ? "text-danger" : "text-success")">
                                                <strong>@result.TemperatureDifference.ToString("F1")</strong>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Графики -->
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart-line"></i> Графики
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="temp-tab" data-bs-toggle="tab"
                                        data-bs-target="#temp-chart" type="button">
                                    Температуры
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="diff-tab" data-bs-toggle="tab"
                                        data-bs-target="#diff-chart" type="button">
                                    Разность
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content mt-3">
                            <div class="tab-pane fade show active" id="temp-chart">
                                <div id="temperatureChart" style="height: 300px;"></div>
                            </div>
                            <div class="tab-pane fade" id="diff-chart">
                                <div id="differenceChart" style="height: 300px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <!-- Пустой экран -->
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-calculator display-1 text-muted mb-3"></i>
                        <h3 class="text-muted">Введите параметры для расчета</h3>
                        <p class="text-muted">Заполните форму слева и нажмите "Рассчитать"</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <!-- Plotly для графиков -->
    <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>

    <script>
        // Функция для быстрой установки значений
        function setValues(h, tm, tg, vg, cg, gm, cm, av, d) {
            document.getElementById('InputData_Height').value = h;
            document.getElementById('InputData_InitialMaterialTemp').value = tm;
            document.getElementById('InputData_InitialGasTemp').value = tg;
            document.getElementById('InputData_GasVelocity').value = vg;
            document.getElementById('InputData_GasHeatCapacity').value = cg;
            document.getElementById('InputData_MaterialConsumption').value = gm;
            document.getElementById('InputData_MaterialHeatCapacity').value = cm;
            document.getElementById('InputData_HeatTransferCoefficient').value = av;
            document.getElementById('InputData_ApparatusDiameter').value = d;
            document.getElementById('InputData_CalculationName').value =
                `Вариант: h=${h}м, tм=${tm}°C, tг=${tg}°C`;
        }

        // Экспорт в CSV
        function exportToCSV() {
            const data = @Html.Raw(Json.Serialize(Model?.Results));
            if (!data || data.length === 0) return;

            let csv = 'y(м),Y,ϑ,θ,t(°C),T(°C),ΔT(°C)\n';
            data.forEach(row => {
                csv += `${row.heightCoordinate},${row.y},${row.phi},${row.theta},`;
                csv += `${row.materialTemperature},${row.gasTemperature},${row.temperatureDifference}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'heat_exchange_calculation.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Графики (рендерим только если есть данные)
        @if (Model?.Results?.Count > 0)
        {
                <text>
                document.addEventListener('DOMContentLoaded', function() {
                    const data = @Html.Raw(Json.Serialize(Model.Results));

                    // График температур
                    const tempTrace1 = {
                        x: data.map(d => d.heightCoordinate),
                        y: data.map(d => d.materialTemperature),
                        mode: 'lines+markers',
                        name: 'Материал (t)',
                        line: { color: '#0d6efd', width: 3, shape: 'spline' },
                        marker: { size: 8, color: '#0d6efd' }
                    };

                    const tempTrace2 = {
                        x: data.map(d => d.heightCoordinate),
                        y: data.map(d => d.gasTemperature),
                        mode: 'lines+markers',
                        name: 'Газ (T)',
                        line: { color: '#fd7e14', width: 3, shape: 'spline' },
                        marker: { size: 8, color: '#fd7e14' }
                    };

                    const tempLayout = {
                        title: { text: 'Распределение температур по высоте слоя', font: { size: 14 } },
                        xaxis: { title: 'Высота, м', gridcolor: '#eee' },
                        yaxis: { title: 'Температура, °C', gridcolor: '#eee' },
                        plot_bgcolor: '#f8f9fa',
                        paper_bgcolor: '#f8f9fa',
                        showlegend: true,
                        legend: { x: 0, y: 1.1, orientation: 'h' },
                        margin: { t: 40, r: 20, b: 40, l: 50 }
                    };

                    Plotly.newPlot('temperatureChart', [tempTrace1, tempTrace2], tempLayout);

                    // График разности температур
                    const diffTrace = {
                        x: data.map(d => d.heightCoordinate),
                        y: data.map(d => d.temperatureDifference),
                        mode: 'lines+markers',
                        name: 'Разность T - t',
                        line: { color: '#198754', width: 3, shape: 'spline' },
                        marker: { size: 8, color: '#198754' },
                        fill: 'tozeroy',
                        fillcolor: 'rgba(25, 135, 84, 0.1)'
                    };

                    const diffLayout = {
                        title: { text: 'Разность температур газа и материала', font: { size: 14 } },
                        xaxis: { title: 'Высота, м', gridcolor: '#eee' },
                        yaxis: { title: 'Разность температур, °C', gridcolor: '#eee' },
                        plot_bgcolor: '#f8f9fa',
                        paper_bgcolor: '#f8f9fa',
                        showlegend: false,
                        margin: { t: 40, r: 20, b: 40, l: 50 }
                    };

                    Plotly.newPlot('differenceChart', [diffTrace], diffLayout);

                    // Активируем табы для графиков
                    const triggerTab = new bootstrap.Tab(document.getElementById('temp-tab'));
                    triggerTab.show();
                });
                </text>
        }
    </script>
}